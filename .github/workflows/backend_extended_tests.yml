# NOTE / INTENT
# ----------------------------------------------------------------------------------
# This workflow runs EXTENDED backend tests (tenant, roles, negative, etc.)
# It is manually triggered only (workflow_dispatch) for full regression runs.
#
# Test Workflow Structure:
#   - backend_tests.yml: Baseline Set (data flow, batch, stress) - automatic on push/PR
#   - backend_tenant_tests.yml: Tenant isolation tests - automatic on push/PR (strict gate)
#   - backend_extended_tests.yml: Full diagnostic suite - manual only
#
# Use this workflow for:
#   - Pre-release full regression
#   - Comprehensive diagnostic runs
#   - Extended test coverage before major milestones
#
# Note: Tenant isolation tests are run here for completeness, but the primary
# tenant isolation gate is backend_tenant_tests.yml (which runs automatically).
# ----------------------------------------------------------------------------------

name: Backend Extended Tests (Manual)

on:
  workflow_dispatch: {}

jobs:
  backend-extended-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      # Set default environment variables for docker-compose.yml
      POSTGRES_DB: nsready
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: nsready_password
      APP_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Docker setup
        run: |
          docker version
          docker compose version

      - name: Create .env file for tests
        run: |
          cat > .env << EOF
          APP_ENV=${{ env.APP_ENV }}
          POSTGRES_DB=${{ env.POSTGRES_DB }}
          POSTGRES_USER=${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          NATS_URL=nats://nats:4222
          EOF

      - name: Start docker compose stack
        timeout-minutes: 10
        run: |
          set -e
          echo "Starting Docker Compose stack..."
          
          # Pull NATS image first with retry logic
          echo "Pulling NATS image..."
          for i in {1..3}; do
            if docker pull nats:2.10-alpine; then
              echo "✅ NATS image pulled successfully"
              break
            else
              echo "⚠️  NATS image pull attempt $i/3 failed, retrying..."
              sleep 5
            fi
          done
          
          # Build and start services
          echo "Building and starting services..."
          docker compose up -d --build
          
          echo "Checking service status..."
          docker compose ps
          
          # Verify containers are running
          if ! docker ps | grep -q nsready_db; then
            echo "❌ nsready_db container not running"
            docker compose logs db
            exit 1
          fi
          
          if ! docker ps | grep -q nsready_nats; then
            echo "❌ nsready_nats container not running"
            docker compose logs nats
            exit 1
          fi
          
          echo "✅ Docker Compose stack started successfully"

      - name: Wait for nsready_db to be ready
        timeout-minutes: 5
        run: |
          set -e
          echo "Waiting for nsready_db to be ready..."
          for i in {1..60}; do
            if docker exec nsready_db pg_isready -U postgres -d nsready 2>/dev/null; then
              echo "✅ nsready_db is ready."
              exit 0
            fi
            echo "⏳ nsready_db not ready yet, retrying in 5s... (attempt $i/60)"
            sleep 5
          done
          echo "❌ nsready_db did not become ready in time."
          docker compose logs db
          exit 1

      - name: Wait for services to be healthy
        timeout-minutes: 5
        run: |
          set -e
          echo "Waiting for services to be healthy..."
          sleep 10
          
          COLLECTOR_HEALTHY=false
          for i in {1..30}; do
            if curl -sf http://localhost:8001/v1/health > /dev/null 2>&1; then
              echo "✅ collector_service is healthy"
              COLLECTOR_HEALTHY=true
              break
            fi
            echo "⏳ Waiting for collector_service... (attempt $i/30)"
            sleep 2
          done
          
          ADMIN_HEALTHY=false
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "✅ admin_tool is healthy"
              ADMIN_HEALTHY=true
              break
            fi
            echo "⏳ Waiting for admin_tool... (attempt $i/30)"
            sleep 2
          done
          
          if [ "$COLLECTOR_HEALTHY" != "true" ]; then
            echo "❌ collector_service did not become healthy in time"
            docker compose logs collector_service || true
            exit 1
          fi
          
          if [ "$ADMIN_HEALTHY" != "true" ]; then
            echo "❌ admin_tool did not become healthy in time"
            docker compose logs admin_tool || true
            exit 1
          fi
          
          echo "✅ All services are healthy"

      - name: Seed registry database
        timeout-minutes: 5
        run: |
          echo "Seeding registry database..."
          docker exec -i nsready_db psql -U postgres -d nsready < nsready_backend/db/seed_registry.sql
          echo "✅ Registry database seeded"

      - name: Make scripts executable
        run: |
          chmod +x shared/scripts/*.sh
          chmod +x shared/scripts/tenant_testing/*.sh 2>/dev/null || true

      - name: Create reports directory
        run: |
          mkdir -p nsready_backend/tests/reports

      - name: Run extended backend tests
        timeout-minutes: 30
        continue-on-error: false
        run: |
          set -e
          
          # Initialize test result variables (0 = success, non-zero = failure)
          TENANT_RC=0
          FINAL_RC=0
          
          echo "========================================="
          echo "Running Extended Backend Tests"
          echo "========================================="
          
          echo ""
          echo "▶️  Test 1/6: Negative Cases Test"
          echo "----------------------------------------"
          ./shared/scripts/test_negative_cases.sh || exit 1
          
          echo ""
          echo "▶️  Test 2/6: Roles/Access Test"
          echo "----------------------------------------"
          ./shared/scripts/test_roles_access.sh || exit 1
          
          echo ""
          echo "▶️  Test 3/6: Multi-Customer Flow Test"
          echo "----------------------------------------"
          ./shared/scripts/test_multi_customer_flow.sh || exit 1
          
          echo ""
          echo "▶️  Test 4/6: Tenant Isolation Test"
          echo "----------------------------------------"
          # Tenant isolation test - run for diagnostic completeness
          # Note: The primary tenant isolation gate is backend_tenant_tests.yml (runs on push/PR)
          # This extended workflow runs it for full regression coverage, but allows it to fail
          # without blocking the diagnostic workflow (since backend_tenant_tests.yml is the strict gate)
          set +e
          ./shared/scripts/test_tenant_isolation.sh
          TENANT_RC=$?
          set -e
          
          if [ "$TENANT_RC" -ne 0 ]; then
            echo ""
            echo "⚠️  Tenant isolation test failed (exit code: $TENANT_RC)"
            echo "   Note: Tenant isolation is also checked in backend_tenant_tests.yml (strict gate on push/PR)."
            echo "   See the TENANT_ISOLATION_TEST_*.md report for detailed findings."
            echo "   The extended workflow continues - this is informational for diagnostic purposes."
            echo ""
          fi
          
          echo ""
          echo "▶️  Test 5/6: SCADA Connection Test"
          echo "----------------------------------------"
          ./shared/scripts/test_scada_connection.sh || echo "⚠️  SCADA test skipped/failed; review logs."
          
          echo ""
          echo "▶️  Test 6/6: Final Test Drive"
          echo "----------------------------------------"
          # Final Test Drive - Kubernetes-only, may not be reachable in CI environment
          # Allow it to fail without failing the workflow (informational only)
          set +e
          ./shared/scripts/final_test_drive.sh
          FINAL_RC=$?
          set -e
          
          if [ "$FINAL_RC" -ne 0 ]; then
            echo ""
            echo "⚠️  Final Test Drive failed (exit code: $FINAL_RC)"
            echo "   This usually means Kubernetes namespace is not reachable in this CI environment."
            echo "   Final Test Drive requires a K8s cluster with proper KUBECONFIG configured."
            echo "   See the FINAL_TEST_DRIVE_*.md report (if generated) for details."
            echo "   The workflow continues - this is informational, not a blocker."
            echo ""
          fi
          
          echo ""
          echo "========================================="
          if [ "$TENANT_RC" -ne 0 ] || [ "$FINAL_RC" -ne 0 ]; then
            echo "✅ Extended Tests Completed"
            if [ "$TENANT_RC" -ne 0 ]; then
              echo "   (tenant isolation has known gaps - see report)"
            fi
            if [ "$FINAL_RC" -ne 0 ]; then
              echo "   (final test drive requires K8s cluster - see report if available)"
            fi
          else
            echo "✅ All Extended Tests PASSED"
          fi
          echo "========================================="

      - name: Show test report summary
        if: always()
        run: |
          echo "========================================="
          echo "Extended Test Reports Generated"
          echo "========================================="
          if [ -d "nsready_backend/tests/reports" ]; then
            ls -lh nsready_backend/tests/reports/ | tail -15
            echo ""
            echo "Recent report files:"
            find nsready_backend/tests/reports -name "*.md" -type f -mmin -60 | sort
          else
            echo "⚠️  Reports directory not found"
          fi

      - name: Upload extended test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-extended-test-reports
          path: nsready_backend/tests/reports/
          retention-days: 7

      - name: Upload service logs
        if: failure()
        run: |
          echo "========================================="
          echo "Service Logs (for debugging)"
          echo "========================================="
          docker compose logs --tail=100 > service_logs.txt
        continue-on-error: true

      - name: Upload service logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: extended-test-service-logs
          path: service_logs.txt
          retention-days: 3

      - name: Stop docker compose stack
        if: always()
        run: |
          docker compose down -v
          echo "✅ Docker stack stopped and volumes removed"

